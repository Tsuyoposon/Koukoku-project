box: python:3.6.0

build: # ビルド設定(パッケージ・ライブラリのインストール確認)
  services:
    - id: mysql
      username: $DOCKER_HUB_ID
      password: $DOCKER_HUB_PASSWORD
      tag: latest
      env:
        MYSQL_ROOT_PASSWORD: root
        MYSQL_DATABASE: koukokuDB

  steps:
    # pipのでパッケージインストール
    - pip-install:
        requirements_file: "requirements.txt"

    - script:
        name: echo python information
        code: |
          echo "python version $(python --version) running"
          echo "pip version $(pip --version) running"
    - script:
        name: sample test code!!
        code: python -m unittest discover sample_testcode -v

    - script:
        name: mysql create table!!
        code: mysql -h$MYSQL_PORT_3306_TCP_ADDR -P$MYSQL_PORT_3306_TCP_PORT -uroot -p$MYSQL_ENV_MYSQL_ROOT_PASSWORD -e "CREATE DATABASE IF NOT EXISTS test;"


test-code: # テストコードの実行!
  steps:
    - pip-install:
        requirements_file: "requirements.txt"

    - script:
        name: mysql create table!!
        code: |
          FLASK_APP=receve_api.py flask db migrate
          FLASK_APP=receve_api.py flask db upgrade

    - script:
      name: twitter_receve!!
      code: python -m unittest test_code/twitter_receve_test.py -v
